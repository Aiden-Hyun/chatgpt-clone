# React Search Agent Cache System

This document explains the cache system used by the React Search Agent.

## Cache Architecture

The cache system uses a two-level approach:
1. In-memory cache for ultra-fast responses
2. PostgreSQL database for persistent storage

### Cache Types

The cache system supports three types of cache entries:
- `search`: For search results
- `url`: For fetched web page content
- `answer`: For synthesized answers

## Database Schema

The cache uses a single consolidated table called `agent_cache` with the following schema:

```sql
CREATE TABLE IF NOT EXISTS public.agent_cache (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  cache_type TEXT NOT NULL, -- 'search', 'url', 'answer'
  key TEXT NOT NULL,
  value JSONB NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  expires_at TIMESTAMPTZ NOT NULL,
  metadata JSONB -- Optional metadata for debugging
);
```

## Setup Instructions

1. Run the migration script to create the cache table:
   ```bash
   supabase db push
   ```

2. Deploy the cache diagnostics function:
   ```bash
   supabase functions deploy cache-diagnostics
   ```

3. Deploy the updated react-search function:
   ```bash
   supabase functions deploy react-search
   ```

## Troubleshooting

If you encounter cache-related issues:

1. Check the cache diagnostics endpoint:
   ```
   https://your-project.supabase.co/functions/v1/cache-diagnostics
   ```

2. Common issues and solutions:
   - **Permission denied errors**: Ensure the service role has proper permissions
   - **Table doesn't exist**: Run the migration script
   - **Cache misses**: Check if the cache is enabled and the keys are consistent

## Cache Manager API

```typescript
// Initialize with options
const cacheManager = new CacheManager(supabaseClient, {
  debug: true,               // Enable detailed logging
  cacheEnabled: true,        // Enable/disable caching
  memCacheEnabled: true,     // Enable/disable memory cache
  tableName: 'agent_cache'   // Table name
});

// Get/set search cache
await cacheManager.getSearchCache(key);
await cacheManager.setSearchCache(key, results, ttlSeconds);

// Get/set URL cache
await cacheManager.getUrlCache(url);
await cacheManager.setUrlCache(url, content, ttlSeconds);

// Get/set answer cache
await cacheManager.getAnswerCache(question);
await cacheManager.setAnswerCache(question, answer, ttlSeconds);

// Maintenance
await cacheManager.cleanupExpired();

// Diagnostics
const stats = cacheManager.getStats();
const diagnostics = await cacheManager.getDiagnostics();
```

## Cache Keys

Cache keys are generated as follows:
- Search cache: Raw key provided by the caller
- URL cache: Hash of the URL
- Answer cache: Hash of the question

## Performance Considerations

- The memory cache significantly improves performance for repeated queries
- Cache entries have TTL (Time To Live) to prevent stale data
- Automatic cleanup of expired entries

## Security

- The cache uses the service role client to ensure proper permissions
- Row-Level Security (RLS) policies are in place to protect the data
- Only authenticated users can access the cache diagnostics endpoint